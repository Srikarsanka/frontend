<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="UTF-8" />
      <title>Socket.IO Chat + WebRTC Video</title>
      <style>
            body {
                  font-family: Arial, sans-serif;
            }

            #messages {
                  list-style-type: none;
                  padding: 0;
                  max-height: 200px;
                  overflow-y: auto;
                  border: 1px solid #ccc;
                  margin-bottom: 10px;
            }

            #messages li {
                  padding: 5px 10px;
            }

            #messages li:nth-child(odd) {
                  background: #eee;
            }

            video {
                  width: 45%;
                  margin: 10px;
                  border: 1px solid black;
            }
      </style>
</head>

<body>
      <label>Username: <input id="username" placeholder="Enter your name" /></label><br /><br />
      <ul id="messages"></ul>
      <input id="m" autocomplete="off" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>

      <h2>Video Chat</h2>
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>

      <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

      <script>
            const socket = io('https://webrtc-backend-siqi.onrender.com');

            const messages = document.getElementById('messages');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');

            let localStream;
            let peerConnection;
            let isCaller = false;

            const config = {
                  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            };

            async function startLocalStream() {
                  try {
                        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        localVideo.srcObject = localStream;
                        console.log('üé• Local stream started');
                        socket.emit('ready'); // Notify others that we're ready
                  } catch (error) {
                        console.error('‚ùå Error accessing media devices.', error);
                  }
            }

            function createPeerConnection() {
                  peerConnection = new RTCPeerConnection(config);

                  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                  peerConnection.ontrack = event => {
                        console.log('üì∂ Remote track received');
                        remoteVideo.srcObject = event.streams[0];
                  };

                  peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                              console.log('üì§ Sending ICE candidate');
                              socket.emit('ice-candidate', event.candidate);
                        }
                  };

                  peerConnection.onconnectionstatechange = () => {
                        console.log('üîÑ Connection state:', peerConnection.connectionState);
                  };
            }

            // --- Signaling Handlers ---

            socket.on('ready', () => {
                  console.log('üü¢ Other user ready');
                  if (!peerConnection) {
                        createPeerConnection();
                        isCaller = true;
                        call();
                  }
            });

            socket.on('offer', async (offer) => {
                  console.log('üì© Offer received');
                  if (!peerConnection) createPeerConnection();
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                  const answer = await peerConnection.createAnswer();
                  await peerConnection.setLocalDescription(answer);
                  socket.emit('answer', answer);
                  console.log('üì§ Sent answer');
            });

            socket.on('answer', async (answer) => {
                  console.log('‚úÖ Answer received');
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            });

            socket.on('ice-candidate', async (candidate) => {
                  try {
                        console.log('‚ùÑÔ∏è ICE candidate received');
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                  } catch (e) {
                        console.error('‚ö†Ô∏è Error adding ICE candidate', e);
                  }
            });

            async function call() {
                  if (!peerConnection) createPeerConnection();
                  const offer = await peerConnection.createOffer();
                  await peerConnection.setLocalDescription(offer);
                  console.log('üì§ Sending offer');
                  socket.emit('offer', offer);
            }

            // --- Chat logic ---

            socket.on('chat message', function (data) {
                  const li = document.createElement('li');
                  li.textContent = `${data.username}: ${data.message}`;
                  messages.appendChild(li);
                  messages.scrollTop = messages.scrollHeight;
            });

            function sendMessage() {
                  const input = document.getElementById('m');
                  const usernameInput = document.getElementById('username');
                  const username = usernameInput.value.trim() || 'Anonymous';

                  if (input.value.trim() !== '') {
                        socket.emit('chat message', {
                              username: username,
                              message: input.value
                        });
                        input.value = '';
                  }
            }

            // Start local stream on load
            startLocalStream();
      </script>

</body>

</html>